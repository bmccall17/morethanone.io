# v0.0.2 - host controls update (partial)

**released:** feb 9, 2026
**status:** partial — share results flow + demo mode pending

## summary

Added host-as-participant toggle, show-live-processing toggle, settings API, processing status lifecycle, and participant processing view. Features 1 and 2 of the host controls FRD are complete. Features 3 (share results flow) and 4 (demo mode) remain.

---

## changes

### host as participant toggle
- Host can opt in as a participant via toggle on lobby page (setup phase only)
- When enabled, a participant record is auto-created for the host on "Start ranking"
- Host sees inline ranking UI (DraggableRankList) alongside host controls during ranking phase
- Host's ranking is counted in tallies and thresholds like any other participant

### show processing toggle (live transparency)
- Host can enable "Show live processing to participants" toggle (setup phase only)
- New `processing` round status added to lifecycle: `setup → ranking → processing → revealed`
- Process API route runs converge() and broadcasts round-by-round data via Supabase Realtime
- New `subscribeToProcessing()` realtime helper for participants to watch rounds as they compute
- Participant processing view page renders RevealAnimation incrementally as data arrives
- Waiting page redirects to processing view when `show_processing` is enabled

### settings API
- New PATCH endpoint at `/api/rounds/[roundId]/settings` for updating round settings
- Host-token authenticated, merges incoming settings with existing (no overwrite)

### database changes
- `host_as_participant` and `show_processing` added to RoundSettings type
- `processing` added to RoundStatus union
- Migration to backfill existing rounds with default settings
- Migration for processing columns (current_processing_round, processing_data)

---

## files changed

### new files
- `src/app/api/rounds/[roundId]/settings/route.ts` — settings PATCH endpoint
- `src/app/api/rounds/[roundId]/process/route.ts` — step-through processing endpoint
- `src/app/round/[roundId]/processing/page.tsx` — participant live processing view
- `supabase/migrations/add_host_settings.sql` — backfill host settings defaults
- `supabase/migrations/add_processing_columns.sql` — processing round columns
- `devnotes/sprint-hostcontrols-backlog.md` — sprint task tracking (12/19 complete)
- `devnotes/frd_HOSTCONTROLSupdate.md` — feature request document

### new test files
- `src/app/api/rounds/[roundId]/settings/__tests__/settings-api.test.ts`
- `src/app/api/rounds/[roundId]/process/__tests__/process-route.test.ts`
- `src/app/api/rounds/[roundId]/close/__tests__/close-processing-status.test.ts`
- `src/app/api/rounds/[roundId]/start/__tests__/start-host-participant.test.ts`
- `src/app/host/[roundId]/lobby/__tests__/host-participate-toggle.test.ts`
- `src/app/host/[roundId]/lobby/__tests__/host-ranking-ui.test.ts`
- `src/app/host/[roundId]/lobby/__tests__/show-processing-toggle.test.ts`
- `src/app/round/[roundId]/processing/__tests__/processing-page.test.ts`
- `src/lib/__tests__/realtime.test.ts`
- `src/types/__tests__/database.test.ts`
- `src/types/__tests__/migration-host-settings.test.ts`

### modified files
- `src/app/host/[roundId]/lobby/page.tsx` — participate toggle, show processing toggle, host ranking UI
- `src/app/api/rounds/[roundId]/start/route.ts` — auto-create host participant
- `src/app/api/rounds/[roundId]/close/route.ts` — processing status when show_processing enabled
- `src/app/api/rounds/route.ts` — default settings include new fields
- `src/app/round/[roundId]/waiting/page.tsx` — redirect to processing view
- `src/lib/realtime.ts` — added subscribeToProcessing helper
- `src/types/database.ts` — host_as_participant, show_processing, processing status
- `supabase/schema.sql` — updated schema with new columns

---

## remaining work (from sprint backlog)

### 3. share results flow (0/4 tasks)
- [ ] Shareable results page at `/results/[roundId]`
- [ ] share_url field on Result type
- [ ] "Share Results" button with clipboard copy
- [ ] Participant reveal page shows shareable link

### 4. demo mode (0/5 tasks)
- [ ] Demo scenario data (3 predefined scenarios)
- [ ] Demo engine (step-by-step converge wrapper)
- [ ] MockParticipantCard component
- [ ] Demo composite view page
- [ ] "Demo Mode" link on home page

---

## verification
- [ ] `npm run build` passes
- [ ] `npm test` passes
- [ ] Vercel deployment live
- [ ] Supabase migrations applied (add_host_settings, add_processing_columns)
