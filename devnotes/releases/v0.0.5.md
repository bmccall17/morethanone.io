# v0.0.5 - host-controlled reveal views + demo upgrades

**released:** feb 10, 2026

## summary
Host can now switch between 3 reveal layouts (animation, selection grid, results table) broadcast to all participants in realtime. Demo mode upgraded with stacked provenance bars, transfer animations, varied ballot depths, and full 16-voter 4x4 grid.

---

## changes

### host-controlled reveal views
- host sees 3-tab switcher on reveal page: Animation, How They Voted, Results Table
- view selection broadcasts to all participants via Supabase Realtime
- **animation view**: stepped bar chart with round dropdown, play/stop button, vote percentages, plain-language explanation panel
- **selection grid ("how they voted")**: color-coded circle matrix showing each participant's ranked choices with legend
- **full results table**: all-rounds tabular view with Votes, %, +/- delta columns per round, inactive ballot row, winner highlighting
- participants see whichever view the host selects (read-only, no switcher)

### demo mode upgrades
- **stacked provenance bars**: when votes transfer, recipient bars show multi-colored segments revealing where each vote came from
- **eliminated options stay visible** at 0 votes with "eliminated" label (never hidden)
- **transfer animation**: bars smoothly shrink/grow with CSS transitions when stepping between rounds
- **segment legends**: micro-labels below multi-source bars showing "2 from C, 1 from E"
- **color-coded transfer indicators**: source/destination arrows with matching option colors
- **varied ballot depths**: voters now rank 2–6 options (not all rank everything), creating realistic exhausted-ballot scenarios
- **all 16 participants shown**: 4x4 grid displays every voter (was capped at 8)
- **transfer highlighting on participant cards**: amber ring + "transferred" label when a voter's choice shifts, persistent amber coloring for previously-transferred voters
- **exhausted voter state**: greyed-out card with "No remaining preferences" when all ranked options eliminated

### bug fixes
- **processing redirect race condition**: participant waiting page now uses a ref for `showProcessing` so the realtime callback always sees the latest value, fixing the bug where participants never redirected to the processing view

### infrastructure
- new db column: `reveal_view_state` (jsonb) on rounds table
- new realtime subscription: `subscribeToRevealView()`
- shared explanation generator extracted from DemoRunner for reuse
- PRD updated to reflect actual sprint history (sprints 1–5)
- created `devnotes/prdnextsteps.md` and `devnotes/prdparkinglot.md` for ongoing planning

---

## files changed

### new files
- `supabase/migrations/add_reveal_view_state.sql` - migration for reveal_view_state column
- `src/app/api/rounds/[roundId]/reveal-view/route.ts` - PATCH endpoint for host to update view state
- `src/app/api/rounds/[roundId]/ballots/route.ts` - GET endpoint for individual ballot data
- `src/lib/reveal/explanations.ts` - shared explanation generator (extracted from DemoRunner)
- `src/components/reveal/RevealViewSwitcher.tsx` - 3-tab host view switcher
- `src/components/reveal/AnimationView.tsx` - stepped bar chart with round controls + explanations
- `src/components/reveal/SelectionGridView.tsx` - color-coded ballot circle grid
- `src/components/reveal/FullResultsTableView.tsx` - all-rounds table with votes/% /+/- columns
- `devnotes/prdnextsteps.md` - working next steps list
- `devnotes/prdparkinglot.md` - parked ideas for future sprints

### modified files
- `src/types/database.ts` - added RevealViewType, RevealViewState, updated Round interface
- `src/lib/realtime.ts` - added subscribeToRevealView()
- `src/app/api/rounds/[roundId]/route.ts` - added reveal_view_state to select
- `src/app/api/rounds/[roundId]/reveal/route.ts` - reset reveal_view_state on reveal
- `src/app/host/[roundId]/reveal/page.tsx` - major rewrite with view switching + broadcast
- `src/app/round/[roundId]/reveal/page.tsx` - major rewrite with realtime view sync
- `src/app/round/[roundId]/waiting/page.tsx` - fixed processing redirect race condition
- `src/components/demo/DemoTallyView.tsx` - stacked provenance bars with transfer animation
- `src/components/demo/MockParticipantCard.tsx` - transfer highlighting + exhausted state
- `src/lib/demo/scenarios.ts` - 16 voters per scenario, varied ballot depths
- `src/app/demo/page.tsx` - show all 16 participants in 4x4 grid
- `devnotes/prd.md` - updated sprint roadmap to reflect actual history

---

## verification
- [x] `npm run build` passes
- [x] `npm test` passes (193 tests)
- [ ] Vercel deployment live
- [ ] Supabase migration applied (`add_reveal_view_state.sql`)
