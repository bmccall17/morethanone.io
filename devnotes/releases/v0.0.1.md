# v0.0.1 - realtime + ranked-choice engine hardening

**released:** feb 8, 2026
**status:** partial — host controls update pending

## summary

Sprint 2 complete: replaced all polling with Supabase Realtime subscriptions, added reveal animation, shareable result card, rule-out UI for participants, and fixed the convergence algorithm to dynamically recalculate majority thresholds per round as rankings exhaust.

---

## changes

### realtime infrastructure
- Added `subscribeToRound`, `subscribeToParticipants`, `subscribeToRankings` helpers in `src/lib/realtime.ts`
- Replaced all 3-second polling intervals with Supabase Realtime subscriptions across host lobby, rank page, and waiting page
- Created Supabase migration to enable realtime on `rounds`, `participants`, `rankings` tables

### reveal animation
- New `RevealAnimation` component — steps through elimination rounds with bar chart, highlights, and transfer animations
- Integrated into both host and participant reveal pages (animation-then-static flow)
- Skip button to jump to final state

### shareable result card
- New `ResultCard` component (1200x630, dark bg, indigo accent) for social sharing
- "Share result" button on both reveal pages using `html2canvas` PNG capture

### rule-out UI
- `DraggableRankList` now has two zones: ranked (counted) and ruled-out (excluded)
- Participants drag options below the "Lock in my ranking" button to exclude them
- Only ranked items are submitted — ruled-out choices carry 0 weight

### convergence algorithm fix
- Majority threshold now recalculates per round: `threshold = floor(active/2) + 1`
- Each round tracks `active`, `inactive`, and `threshold` fields
- `winning_percentage` calculated against active (non-exhausted) rankings in final round
- Summary uses "post-redistribution" language when rankings exhaust
- 4 new tests covering threshold shrinkage, structural validation, post-redistribution percentage, and summary language

---

## files changed

### new files
- `src/lib/realtime.ts` — Supabase Realtime subscription helpers
- `src/components/RevealAnimation.tsx` — animated round-by-round reveal
- `src/components/ResultCard.tsx` — social sharing card (1200x630)
- `supabase/migrations/enable_realtime.sql` — enable realtime for core tables
- `devnotes/sprint-2-backlog.md` — sprint 2 task tracking (14/14 complete)
- `devnotes/rankedchoicemethod.md` — ranked-choice algorithm spec
- `.ralphy/config.yaml` — ralphy project configuration

### modified files
- `src/app/host/[roundId]/lobby/page.tsx` — polling → realtime subscriptions
- `src/app/host/[roundId]/reveal/page.tsx` — animation integration + share button
- `src/app/round/[roundId]/rank/page.tsx` — polling → realtime
- `src/app/round/[roundId]/reveal/page.tsx` — animation integration + share button
- `src/app/round/[roundId]/waiting/page.tsx` — polling → realtime
- `src/components/DraggableRankList.tsx` — two-zone ranked/ruled-out drag-and-drop
- `src/lib/engine/converge.ts` — dynamic per-round threshold recalculation
- `src/lib/engine/summarize.ts` — post-redistribution language
- `src/lib/engine/types.ts` — `active`, `inactive`, `threshold` on `ConvergeRound`
- `src/lib/engine/__tests__/converge.test.ts` — updated + 4 new tests (18 total passing)
- `src/types/database.ts` — `active`, `inactive`, `threshold` on `RoundData`
- `package.json` — version 0.0.1, added `html2canvas`
- `next.config.ts` — turbopack root fix

---

## verification
- [x] `npm run build` passes
- [x] `npm test` — 18/18 converge tests passing
- [ ] Vercel deployment live
- [ ] Supabase realtime migration applied
