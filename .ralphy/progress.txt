# Ralphy Progress Log
- [✓] 2026-02-09 14:19 - Update the `Round` type in `src/types/database.ts` to add `host_as_participant: boolean` to the `settings` object (default `false`). Also add `show_processing: boolean` (default `false`) to the settings object while here since it's needed for feature 2.
- [✓] 2026-02-09 14:21 - Add a migration at `supabase/migrations/add_host_settings.sql` that updates existing rounds to include the new settings defaults. Add a comment noting the settings column is JSONB and these are new keys within it.
- [✓] 2026-02-09 17:23 - Add a "Participate in this round" toggle to the host lobby page at `src/app/host/[roundId]/lobby/page.tsx`. Place it in the host controls area before the action buttons. When toggled on, send a PATCH/POST to update the round settings with `host_as_participant: true`. Use the existing `Toggle` component from `src/components/ui/Toggle.tsx`. The toggle should only be available during `setup` status and disabled after ranking starts.
- [✓] 2026-02-09 17:25 - Create an API route at `src/app/api/rounds/[roundId]/settings/route.ts` that accepts PATCH requests with a JSON body to update the round's settings column. Require the `X-Host-Token` header for authentication (follow the same pattern as `src/app/api/rounds/[roundId]/start/route.ts`). Merge the incoming settings with existing settings (spread operator, not replace).
- [✓] 2026-02-09 17:28 - When `host_as_participant` is enabled and the host clicks "Start ranking", automatically create a participant record for the host. Modify `src/app/api/rounds/[roundId]/start/route.ts` to check the round's `host_as_participant` setting — if true, insert a participant row with `display_name: 'Host'` and `round_id`, then return the new participant ID in the response. The host lobby page should store this participant ID in localStorage (same pattern as the join flow in `src/app/join/page.tsx`).
- [✓] 2026-02-09 17:30 - When the host is a participant, show the ranking interface to the host after they click "Start ranking". In `src/app/host/[roundId]/lobby/page.tsx`, when status is `ranking` and the host has a participant ID in localStorage, render the `DraggableRankList` component from `src/components/DraggableRankList.tsx` inline within the lobby page (above the submission counter and close button). After the host submits their ranking, hide the ranking UI and show a "Ranking submitted" confirmation. The host should still see all host controls (submission counter, close ranking button) alongside their ranking UI.
- [✓] 2026-02-09 17:32 - Add a "Show live processing to participants" toggle to the host lobby page at `src/app/host/[roundId]/lobby/page.tsx`. Place it near the "Participate" toggle. When toggled, update round settings via the settings API route created above with `show_processing: true`. This toggle should only be available during `setup` status. Use the existing `Toggle` component.
- [✓] 2026-02-09 17:34 - Add a new round status value `processing` to the `RoundStatus` type in `src/types/database.ts`. The flow becomes: `setup → ranking → processing → revealed`. Update the status transition in `src/app/api/rounds/[roundId]/close/route.ts` to set status to `processing` instead of `closed` when `show_processing` is enabled in the round settings. When `show_processing` is disabled, keep the existing `closed` status.
- [✓] 2026-02-09 17:39 - Create an API route at `src/app/api/rounds/[roundId]/process/route.ts` for stepping through the ranked-choice algorithm. When called with POST, it should: (1) run the `converge()` function from `src/lib/engine/converge.ts`, (2) store each round's data incrementally by updating a `processing_data` column on the results table (or a new `round_processing` table), and (3) broadcast each round's result via Supabase Realtime by updating the round row with a `current_processing_round` integer field. Require `X-Host-Token` authentication.
- [✓] 2026-02-09 17:41 - Add a realtime subscription helper `subscribeToProcessing(roundId, callbacks)` in `src/lib/realtime.ts` that listens for UPDATE events on the `rounds` table and calls `onProcessingUpdate(roundNumber)` when `current_processing_round` changes. Participants use this to know when new round data is available to fetch and display.
- [✓] 2026-02-11 04:08 - Add an API route at `src/app/api/rounds/[roundId]/participants/[participantId]/remove/route.ts` that accepts POST requests to mark a participant as removed. Set the existing `removed` boolean column to `true` on the `participants` table. Require `X-Host-Token` authentication (same pattern as `src/app/api/rounds/[roundId]/start/route.ts`). Return 200 on success. The removed participant's rankings should be excluded from processing (check that `converge.ts` already filters these, or add filtering).
- [✓] 2026-02-11 04:12 - Add a "Remove" button next to each player in the `PlayerList` component at `src/components/PlayerList.tsx` (visible only to hosts). When clicked, call the remove participant API route. After removal, the player should disappear from the list via the existing realtime subscription. Only show the remove button during `setup` and `ranking` status.
- [✓] 2026-02-11 04:13 - Add an API route at `src/app/api/rounds/[roundId]/options/remove/route.ts` that accepts POST with `{ option: string }` to remove an option from the round's `options` jsonb array. Require `X-Host-Token` authentication. Only allow removal during `setup` status. Update the `options` column on the `rounds` table. Return the updated options list.
- [✓] 2026-02-11 04:16 - Add a "Remove" button (small X icon) next to each option in the host lobby view at `src/app/host/[roundId]/lobby/page.tsx`. When clicked, call the remove option API route. Only show during `setup` status. After removal, re-fetch or realtime-update the options list.
- [✓] 2026-02-11 04:18 - Add a basic profanity filter utility at `src/lib/profanity.ts`. Export a `containsProfanity(text: string): boolean` function and a `cleanText(text: string): string` function that replaces profane words with asterisks. Use a hardcoded blocklist of common profane words (no external dependency). Apply the filter in the join API route (`src/app/api/rounds/join/route.ts`) for display names, and in the create round API route (`src/app/api/rounds/route.ts`) for option text. Return a 400 error with a user-friendly message if profanity is detected.
- [✓] 2026-02-11 04:25 - Add a `timer_minutes` field to the round settings object in `src/types/database.ts`. Add a "Set timer" input to the host create page at `src/app/host/create/page.tsx` — a numeric input for minutes (optional, default: no timer). Store it in the round's settings jsonb when creating. On the ranking page (`src/app/round/[roundId]/rank/page.tsx`) and host lobby (`src/app/host/[roundId]/lobby/page.tsx`), show a countdown timer when `timer_minutes` is set. Calculate deadline from when ranking started (the `ranking_started_at` timestamp or round `updated_at`). When the timer expires, auto-close ranking by calling the close API route (host-side) or show "time's up" (participant-side). Host can still close early.
